#!/bin/bash
### __Seed builder__
# AUTO_GENERATED
# Add custom commands at the end
# Use $ bin/setup.sh <reactjs_port> <is_prod>

echo "== Configuring docker .env"
REACTJS_PORT=3003
IS_PROD=false

if [ $# -ge 1 ]; then REACTJS_PORT=$1; fi
if [ $# -ge 2 ]; then IS_PROD=$2; fi

RUNNING=$(sudo docker ps)
if [ $RUNNING -z ]; then
  echo "ERROR: Before executing bin/setup.sh, start docker service"
  exit 1
fi

echo "== Creating docker .envs"
sudo rm .env
echo "# DOCKER SETTINGS" > ".env"
echo "### MODIFY WITH WITH $ bin/setup.sh REACTJS_PORT IS_PROD ###" >> ".env"
echo "" >> ".env"
echo "COMPOSE_PROJECT_NAME=reactjs_reference_frontend" >> ".env"
echo "COMPOSE_REACTJS_PORT=$REACTJS_PORT" >> ".env"
echo "REACT_APP_IS_PROD=$IS_PROD" >> ".env"
echo "PORT=$REACTJS_PORT" >> ".env"

echo "== Deleting previous containers"
sudo docker compose down

echo "== Building project"
sudo docker compose build

echo "== Setting execute permissions to bin"
sudo docker compose run --rm reactjs /bin/sh -c "chmod +x bin/*.sh"

echo "== Starting services"
sudo docker compose up -d

echo "== Removing root permissions"
sudo chown -R $(whoami) .

echo "== Installing local dependencies"
npm install --legacy-peer-deps

echo "== Cleaning setup"
sudo docker compose stop
sudo docker image prune --force
sudo docker volume prune --force

echo ""
echo "== Setup completed (Start server with bin/start.sh)"
echo ""

#  __End autogenerated__
#  Include commands after this block
###